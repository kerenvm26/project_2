---
title: "Project_2: Contacting an API"
author: "Keren Vivas"
date: "`r Sys.Date()`"
output: 
  github_document: 
    toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

# Introduction

# Required Packages

```{r}
library(httr)
library(jsonlite)
library(tidyverse)
library(dplyr)
library(ggplot2)
```


# Functions to Interact with the API

## 1. Products based on product_type:

```{r}
product_type <- function(type="all") {
  
    query_API <- fromJSON("http://makeup-api.herokuapp.com/api/v1/products.json")
    
    #Filter products by the specified product_type
    filtered_products <- query_API[!is.na(query_API$product_type) & query_API$product_type == type, ]
    return(filtered_products)
}
  
```

To test product_prices_by_product_type function 
```{r}
mascara <- product_type("mascara")
mascara

foundation <- product_type("foundation")
foundation

nail_polish <- product_type("nail_polish")
nail_polish

```

## 2. Product prices based on currency

```{r}
product_prices_by_currency <- function(currency) {
  
    query_API <- fromJSON("http://makeup-api.herokuapp.com/api/v1/products.json")
    
    #Filter products by the specified currency
    filtered_products <- query_API[!is.na(query_API$currency) & query_API$currency == currency, ]
    return(filtered_products)
}
```

To test product_prices_by_currency function 
```{r}
CAD_prices <- product_prices_by_currency("CAD")
CAD_prices

USD_prices <- product_prices_by_currency("USD")
USD_prices 

GBP_prices <- product_prices_by_currency("GBP")
GBP_prices
```

## 3. Products based on product tag:

```{r}

product_tag <- function(tag="all") {
  query_API <- fromJSON("http://makeup-api.herokuapp.com/api/v1/products.json")

  # Split the tag_list into separate columns
  query_API2 <- query_API %>%
    separate(tag_list, into = c("Tag1", "Tag2", "Tag3", "Tag4", "Tag5", "Tag6", "Tag7", "Tag8"), sep = ",")

  # Filter rows where any of the columns contains the specified tag
  filtered_products <- query_API2 %>%
    filter_at(vars(starts_with("Tag")), any_vars(. == tag))

  return(filtered_products)
}
```

To test product_tag function
```{r}
Vegan_products <- product_tag("Vegan")
Vegan_products

Canadian_products <- product_tag("Canadian")
Canadian_products

Natural_products <- product_tag("Natural")
Natural_products
```

## 4. Products based on brand and product type
```{r}
product_brand_type <- function(brand, type="all") {
  
    query_API <- fromJSON("http://makeup-api.herokuapp.com/api/v1/products.json")
    
    #Filter products by the specified brand and type
    filtered_products <- query_API[!is.na(query_API$brand) & query_API$brand == brand & !is.na(query_API$product_type) & query_API$product_type == type, ]
    return(filtered_products)
}
```

To test product_prices_by_currency function 
```{r}
deciem_foundation <- product_brand_type("deciem", "foundation" )
deciem_foundation

nyx_mascara <- product_brand_type("nyx", "mascara")
nyx_mascara

mabelline_blush <- product_brand_type("maybelline", "blush")
mabelline_blush
```

## 5-6. Products based on brand, product type and price (greater/lower and equal to)

```{r}
product_brand_type_price <- function(brand, type="all", price_operator, price_value) {
  
    query_API <- fromJSON("http://makeup-api.herokuapp.com/api/v1/products.json")

    filtered_data <- query_API[!is.na(query_API$brand) & query_API$brand == brand & !is.na(query_API$product_type) & query_API$product_type == type, ]
    
    if (price_operator == 'greater') {
    filtered_data <- filtered_data[!is.na(filtered_data$price) & filtered_data$price >= as.numeric(price_value), ]
     }
    else if (price_operator == 'lower') {
    filtered_data <- filtered_data[!is.na(filtered_data$price) & filtered_data$price <= as.numeric(price_value), ]
    }
  
  return(filtered_data)
}
```

To test  function 
```{r}
colourpop_lipstick_price <- product_brand_type_price("colourpop", "lipstick", "greater", "5")
colourpop_lipstick_price
```

# Exploratory Data Analysis (EDA): Summarizing data from an API

Questions:  
  1. What are the type of make-up products and brand with more options?
  2. What are the type of make-up products and brand more expensive?
  3. What about within USA market and others?

  
# One_way contengency table
```{r}
all_product_type <- query_API
contigency_data <- all_product_type[,"product_type"]
contigency_table <- table(contigency_data)
print(contigency_table)
```

## Two_way contengency table
```{r}
all_product_type <- query_API
contigency_data <- all_product_type[,c("brand","product_type")]
contigency_table <- table(contigency_data)
print(contigency_table)
```

#Two_way contengency table filtering using function
```{r}
# Select columns for the contingency table (brand and tag columns)
all_USD_product <- product_prices_by_currency("USD")
contingency_data <- all_USD_product[, c("product_type", "brand")]

# Create a contingency table
contingency_table <- table(contingency_data)

# Print the contingency table
print(contingency_table)
```

# Stacked_bar_plot 
```{r}
my_data_filtered <- query_API[!is.na(query_API$currency) & !is.na(query_API$product_type), ]

# Create a stacked bar plot with a custom color palette
stacked_bar_plot <- ggplot(my_data_filtered, aes(x = product_type, fill = currency)) +
  geom_bar(position = "stack") +
  labs(title = "Stacked Bar Plot of Product Type Counts by Currency",
       x = "Product Type", y = "Count") +
  scale_fill_brewer(palette = "Set1", type = "qual", direction = 1)  # Choose "Set1" with three colors

# Print the stacked bar plot
print(stacked_bar_plot)
```

# Violin plot

```{r}
my_data_filtered <- query_API[!is.na(query_API$price) & !is.na(query_API$product_type), ]

violin_plot <- ggplot(my_data_filtered, aes(x = product_type, y = as.numeric(price))) +
  geom_violin() +
  labs(title = "Violin Plot of Prices by Product type",
       x = "Product type", y = "Price")

# Print the violin plot
print(violin_plot)

```

# Print the histogram
```{r}
my_data_filtered <- query_API[!is.na(query_API$price) & !is.na(query_API$product_type), ]

  # Create a single boxplot for prices without faceting
  histogram_plot <- ggplot(my_data_filtered, aes(x = as.numeric(price))) +
  geom_histogram() +
 labs(title = "Histogram of Prices Faceted by Product Type", x = "Price", y= "Counts")+
   facet_wrap(~product_type)
 
 # Print the histogram
print(histogram_plot)
```
